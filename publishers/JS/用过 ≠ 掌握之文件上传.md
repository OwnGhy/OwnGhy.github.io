<!--title: ç”¨è¿‡ =Ì¸ æŒæ¡ä¹‹æ–‡ä»¶ä¸Šä¼ -->
<!--date: 2019.10.23-->
<!--cate: 1-->
åœ¨å¼€å‘ä¸­ï¼Œè™½ç„¶ç»å¸¸å€ŸåŠ©ç»„ä»¶åº“ or å·¥å…·åº“å®ç°äº†å¾ˆå¤šä¸šåŠ¡åŠŸèƒ½ï¼Œä½†å¾€å¾€éƒ½æ²¡æœ‰å»æ¢ç©¶è¿‡åŸç†æˆ–è€…è‡ªå·±æ‰‹åŠ¨å®ç°è¿‡ã€‚è™½ç„¶åœ¨æ•æ·å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸è¦é‡å¤é€ è½®å­æ‰èƒ½æ»¡è¶³æ•æ·å¼€å‘çš„å¿«èŠ‚å¥çš„éœ€æ±‚ã€‚ä½†æ˜¯å­¦ä¹ å…¶ä¸­çš„åŸç†èƒ½å¯¹æˆ‘ä»¬çš„æ°´å¹³æœ‰å¾ˆå¤§çš„æå‡ã€‚

ä¸ºäº†è®©è‡ªå·±åšæŒä¸‹å»ï¼Œä¸è®©è‡ªå·±æˆä¸ºä¸€ä¸ª **API è°ƒç”¨å¸ˆ**ï¼Œç«‹ä¸€ä¸ª flagï¼Œæ¯å‘¨è‡³å°‘å­¦ä¹ ä¸€ä¸ª**ç”¨è¿‡ â‰  æŒæ¡**çš„çŸ¥è¯†ï¼Œä¼šé™†é™†ç»­ç»­å‡ºè¿™ä¸ªç³»åˆ—çš„ç¬”è®°ã€‚

è¿›å…¥æ­£é¢˜ã€‚

æ­£å¥½ä»Šå¤©çœ‹åˆ°ä¸€ç¯‡æ–‡ä»¶ä¸Šä¼ å¾ˆå®Œæ•´çš„åšå®¢ï¼Œæ‰€ä»¥å¯¹è¿™æ–¹é¢åšä¸€ä¸ªçŸ¥è¯†æ•´ç†ã€‚
<!-- more -->

å‚è€ƒï¼š[å†™ç»™æ–°æ‰‹å‰ç«¯çš„å„ç§æ–‡ä»¶ä¸Šä¼ æ”»ç•¥ï¼Œä»å°å›¾ç‰‡åˆ°å¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ ](https://juejin.im/post/5da14778f265da5bb628e590)

### HTTP æ–‡ä»¶ä¸Šä¼ èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

#### æ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ

æ–‡ä»¶æœ¬è´¨ä¸Šå°±æ˜¯ç£ç›˜ä¸Šçš„ä¸€æ®µç©ºé—´ï¼Œæ–‡ä»¶çš„å†…å®¹å°±æ˜¯ä¸€ä¸² 2 è¿›åˆ¶æ•°å­—ï¼ˆ1 æˆ–è€… 0ï¼‰ã€‚

æ–‡ä»¶ä¼ è¾“ï¼Œå°±æ˜¯æŠŠè¿™ä¸²æ•°å­—åŒæ„Ÿ http åè®®ä¼ è¿‡å»ã€‚

æœåŠ¡å™¨ç«¯ï¼Œæ¥åˆ°è¿™æ®µæ•°æ®ä¹‹åï¼ŒæŒ‰ç…§åè®®è§„å®šçš„æ ¼å¼ï¼ŒæŠŠè¿™ä¸²æ•°å­—å–å‡ºæ¥ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼ˆåˆ†é…ä¸€æ®µç©ºé—´ï¼‰ï¼Œç„¶åæŠŠè¿™æ®µæ•°å­—å†™è¿›å»ï¼Œå°±æˆäº†ä¸€ä¸ªè·Ÿä¸Šä¼ æ–‡ä»¶å®Œå…¨ä¸€è‡´çš„æ–°æ–‡ä»¶ã€‚

å‚è€ƒï¼š[httpï¼šæ–‡ä»¶ä¸Šä¼ èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ - éšæºªæ¼‚èƒ–çŒ«çš„å›ç­” - çŸ¥ä¹](httpï¼šæ–‡ä»¶ä¸Šä¼ èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ - éšæºªæ¼‚èƒ–çŒ«çš„å›ç­” - çŸ¥ä¹
https://www.zhihu.com/question/58118565/answer/155688756)

#### MIME æ˜¯ä»€ä¹ˆï¼Ÿ

**MIME** å¹¶ä¸é™Œç”Ÿï¼Œä½†æ˜¯ä¸€ç›´éƒ½ä¸æ˜¯å¾ˆæ˜ç™½å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆã€‚åœ¨ HTTP è¯·æ±‚ä¸­ä¹Ÿä¼šç”¨åˆ° **MIME**ï¼Œæ‰€ä»¥å…ˆé¢„å¤‡ä¸€ä¸‹çŸ¥è¯†ã€‚**MIME** ä¸æ˜¯ HTTP åè®®çš„ä¸€éƒ¨åˆ†ï¼Œå…¶å…¨ç§° **MIMEï¼ˆMultipurpose Internet Mail Extensionsï¼‰**å³å¤šç”¨é€”äº’è”ç½‘é‚®ä»¶æ‰©å±•ç±»å‹ã€‚å…¶æœ¬è´¨å°±æ˜¯ç”¨äºæ ¹æ®æ¯ä¸ªèµ„æºè‡ªèº«çš„å±æ€§æ ‡è¯†æ¯ä¸ªèµ„æºçš„ç±»å‹ï¼Œä¾‹å¦‚è§†é¢‘ã€HTML é¡µé¢ã€å›¾ç‰‡ç­‰ï¼Œéƒ½æ˜¯ä¸åŒç±»å‹çš„èµ„æºã€‚

ä¾‹å¦‚é€šè¿‡`http://localhost/image.png`è®¿é—®å›¾ç‰‡ï¼Œå¹¶ä¸æ˜¯æ ¹æ®.pngåç¼€å»åˆ¤æ–­èµ„æºçš„ç±»å‹ï¼Œè€Œæ˜¯é€šè¿‡è·å–è¿™ä¸ªèµ„æºçš„ **MIME** æ¥è·å–è¿™ä¸ªèµ„æºçš„ç±»å‹`image/png`ã€‚

**MIME** ä½¿ç”¨çš„åœ°æ–¹å¾ˆå¤šï¼š

- HTTP è¯·æ±‚å¤´ä¸­ï¼Œç”¨äºè®¾ç½® `Content-Type` å»æ ‡è¯†å½“å‰è¯·æ±‚ä½“ä¸­çš„æ•°æ®æ ¼å¼ç±»å‹
- `<script type='text/javascript'></script>`ç­‰ç±»ä¼¼çš„æ ‡ç­¾å»æ ‡è¯†èµ„æºçš„ç±»å‹
- ...

æ‰€æœ‰ **MIME** ç±»å‹å€¼ï¼š[MIME å‚è€ƒæ‰‹å†Œ](https://www.w3school.com.cn/media/media_mimeref.asp)ã€‚

#### Content-Type å‡ ç§å¸¸è§çš„ç±»å‹

**Content-Type** ç”¨äºè¯´æ˜è¯·æ±‚æˆ–è¿”å›çš„æ¶ˆæ¯ä¸»é¢˜æ˜¯ç”¨ä»€ä¹ˆæ–¹å¼ç¼–ç ã€‚

å¸¸è§çš„ç±»å‹æœ‰ï¼š

- `application/x-www-form-urlencoded`ï¼šæµè§ˆå™¨çš„åŸç”Ÿformè¡¨å•ï¼Œæäº¤çš„æ•°æ®æŒ‰ key1=val1&key2=val2 çš„æ–¹å¼è¿›è¡Œç¼–ç ï¼Œkey å’Œ val éƒ½è¿›è¡Œäº† URL è½¬ç 
- `multipart/form-data`ï¼šå¸¸è§çš„ POST æ•°æ®æäº¤æ–¹å¼ï¼Œä½¿ç”¨è¡¨å•ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œéœ€è®¾ç½® form çš„ enctype='multipart/form-data'
- `application/json`ï¼šæ•°æ®æ—¶åºåˆ—åŒ–åçš„ JSON å­—ç¬¦ä¸²

æ›´å¤šçš„ç±»å‹å‚è€ƒï¼š[HTTP content-type](https://www.runoob.com/http/http-content-type.html)

#### ä¸Šä¼ æ–‡ä»¶çš„ HTTP æŠ¥æ–‡åˆ†æ

æ™®é€š Form è¡¨å•æ•°æ®è¯·æ±‚æŠ¥æ–‡:

```
POST /upload HTTP/1.1
Host: localhst
Cache-Control: no-cache
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarybygnDMezTNBFKJW8


------WebKitFormBoundarybygnDMezTNBFKJW8
Content-Disposition: form-data; name="param1"

1
------WebKitFormBoundarybygnDMezTNBFKJW8
Content-Disposition: form-data; name="param2"

2
------WebKitFormBoundarybygnDMezTNBFKJW8--

```

åœ¨è¯·æ±‚å¤´ä¸­çš„ `Content-Type` ç±»å‹æ˜¯ `multipart/form-data`ï¼Œå…¶ä¸­ boundary=----xxx æ˜¯å¤šä¸ªè¡¨å•é¡¹ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œä»¥è¾¾åˆ°åˆ†å‰²æ•°æ®çš„ç›®çš„ã€‚åˆ†å‰²å¾—åˆ°çš„è¡¨å•é¡¹ä¸­ï¼Œ `Content-Disposition` åŒ…å«äº†è¡¨å•é¡¹çš„åŸºæœ¬ä¿¡æ¯ï¼Œå›ºå®šä»¥ `form-data` å¼€å¤´ï¼Œname è¡¨ç¤ºè¡¨å•å…ƒç´ å±æ€§åã€‚æ¢è¡Œä¹‹åå°±æ˜¯è¡¨å•é¡¹çš„å€¼ã€‚

å«æ–‡ä»¶çš„ Form è¡¨å•æ•°æ®è¯·æ±‚æŠ¥æ–‡ï¼š

```
POST /upload HTTP/1.1
Host: localhst
Cache-Control: no-cache
Content-Type: multipart/form-data; boundary=----Boundary

------Boundary
Content-Disposition: form-data; name="file"; filename="file.png"
Content-Type: image/png

<è¿™é‡Œæ˜¯å›¾ç‰‡äºŒè¿›åˆ¶å†…å®¹>
------Boundary
Content-Disposition: form-data; name="param1"

value1
------Boundary
Content-Disposition: form-data; name="param2"

value2
------Boundary--
```

ä¸Šé¢å°±æ˜¯ä¸€ä¸ªåŒ…å«æ–‡ä»¶ä¸Šä¼ çš„è¯·æ±‚æŠ¥æ–‡ï¼Œä¸æ™®é€šçš„è¡¨å•æ•°æ®çš„æŠ¥æ–‡ä¸åŒï¼Œæ–‡ä»¶çš„è¡¨å•é¡¹ä¸­çš„ `Content-Disposition` ä¼šå¤šä¸€ä¸ª `filename` æ ‡è¯†ä¸Šä¼ çš„æ–‡ä»¶çš„åç§°ï¼›é™¤æ­¤ä¹‹å¤–è¿˜ä¼šå¤šä¸€ä¸ª `Content-Type` æ ‡è¯†ä¸Šä¼ çš„æ–‡ä»¶çš„ç±»å‹ã€‚

#### HTTP æ–‡ä»¶ä¼ è¾“åŸç†

HTTP åè®®æ˜¯åŸºäº TCP çš„**æµå¼ä¼ è¾“åè®®**ï¼Œåœ¨æ–‡ä»¶ä¼ è¾“çš„æ—¶å€™ï¼Œå¯ä»¥å€ŸåŠ© TCP çš„ç‰¹ç‚¹ã€‚

- åˆ†å—ä¼ è¾“ï¼šTCP æ•°æ®åŒ…çš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œå½“ä¼ è¾“å¤§é‡æ•°æ®æ—¶ï¼Œå°±å¿…é¡»åˆ†æˆå¤šä¸ªæ•°æ®åŒ…è¿›è¡Œä¼ è¾“ï¼Œæ¯ä¸ªåŒ…æ‹¥æœ‰**ç¼–å·**ï¼Œä»¥ä¾¿æ¥å—ç«¯æŒ‰ç…§é¡ºåºè¿˜åŸæ•°æ®ï¼Œä¸”å¯ä»¥åœ¨ä¸¢åŒ…æ—¶æ‰¾åˆ°ä¸¢å¤±çš„åŒ…ã€‚HTTP åè®®å¤´ä¿¡æ¯çš„ `Content-Length` è¡¨ç¤ºä¿¡æ¯ä½“çš„å¤§å°ï¼Œç”¨äºæ¥å—ç«¯ç¡®å®šä¼ è¾“çš„ç»“æŸ
- æ–­ç‚¹ç»­ä¼ ï¼šå½“å‡ºç°ä¸¢åŒ…æ—¶ï¼Œä¼šè¿›è¡Œé‡ä¼ ï¼Œè¿™ä¹Ÿæ˜¯ TCP å¯é ä¼ è¾“çš„ç‰¹ç‚¹ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡åˆç†çš„å¾€è¿”æ—¶å»¶ï¼ˆ**RTT**ï¼‰è¿˜æœªæ”¶åˆ°ç¡®è®¤ç ï¼Œå°±ä¼šè¢«è®¤ä¸ºæ˜¯å‡ºç°äº†ä¸¢åŒ…çš„æƒ…å†µ
- å¤šçº¿ç¨‹ä¼ è¾“ï¼šæ¯ä¸ªæ•°æ®åŒ…çš„ä¼ è¾“ï¼Œäº’ç›¸ä¹‹é—´ä¸ä¼šé˜»å¡ï¼Œæ˜¯å¹¶è¡Œçš„

### åŸºç¡€ä¸Šä¼ æ¥å£

#### Nodejs åŸç”Ÿ

```js
const http = require('http');
const fs = require('fs');
const querystring = require('querystring');

// ç”¨ http æ¨¡å—åˆ›å»ºä¸€ä¸ª http æœåŠ¡å™¨
http.createServer((req, res) => {
		// åˆ¤æ–­è¯·æ±‚ url
    if (req.url === '/upload') {
    		// åˆ¤æ–­ method
        if (req.method.toLowerCase() === 'get') {
            // æ˜¾ç¤ºä¸€ä¸ªç”¨äºä¸Šä¼ æ–‡ä»¶çš„form
            res.writeHead(200, {'content-type': 'text/html'});

            res.end(
                `<form action="/upload" enctype="multipart/form-data" method="post">
                <input type="file" name="upload" multiple="multiple" />
                <input type="submit" value="Upload" />
            </form>`
            )
        } else {
            //è¿™é‡ŒæŒ‡å®šç¼–ç ï¼Œå¤„ç†ä¹±ç çš„é—®é¢˜
            res.writeHead(200, {'Content-Type': 'text/plain;charset=utf-8'});

            if (req.headers['content-type'].indexOf('multipart/form-data') !== -1) {
            		// è§£ææ–‡ä»¶
                parseFile(req, res);
            } else if (req.method.toLowerCase() === 'post') {
                res.end('å…¶ä»–æäº¤æ–¹å¼');
            }
        }
    } else {
    		res.end('404');
    }
}).listen(3000);

console.log('listening on 3000....');

function parseFile(req, res) {
		// äºŒè¿›åˆ¶
    req.setEncoding('binary');
    let body = ''; // æ–‡ä»¶æ•°æ®
    let fileName; // æ–‡ä»¶å
    let contentType; // æ–‡ä»¶ç±»å‹

    // è¾¹ç•Œå­—ç¬¦ä¸²
    var boundary = req.headers['content-type'].split(';')[1].replace('boundary=', '');

		// http æ–‡ä»¶æ˜¯åˆ†å—ä¼ è¾“çš„ï¼Œéœ€è¦ä¾æ¬¡æ¥æ”¶ä¼ è¾“æ•°æ®
    req.on('data', function (chunk) {
        body += chunk;
    });

    req.on('end', function () {
        try {
            const file = querystring.parse(body, '\r\n', ':');
            // åªå¤„ç†å›¾ç‰‡
            if (file['Content-Type'].indexOf('image') !== -1) {
                // è·å–æ–‡ä»¶å
                fileName = file['Content-Disposition'].match(/filename="(.*)"/)[1];
                // è·å–å›¾ç‰‡ç±»å‹
                contentType = file['Content-Type'].substring(1);
                // è·å–æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®å¼€å§‹ä½ç½®ï¼Œå³ contentType çš„ç»“å°¾
                const upperBoundary = body.toString().indexOf(contentType) + contentType.length;
                const shorterData = body.toString().substring(upperBoundary);
                // æ›¿æ¢å¼€å§‹ç»“æŸä½ç½®çš„ç©ºæ ¼
                const binaryData = shorterData.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
                // ä¿å­˜æ–‡ä»¶
                fs.writeFile(fileName, binaryData, 'binary', function (err) {
                    res.end('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                })
            } else {
                res.end('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
            }
        } catch (err) {
            console.log(err);
            res.end('å‡ºé”™' + err);
        }
    });
}
```

#### Koa

- [koa-static](https://github.com/dlau/koa-body)ï¼šé™æ€èµ„æºç®¡ç†ä¸­é—´ä»¶ï¼Œä½¿ç”¨äº†ä¹‹åå¯ä»¥ç›´æ¥è®¿é—®æœåŠ¡çš„é™æ€èµ„æº
- [koa-body](https://github.com/dlau/koa-body)ï¼škoaä¸»ä½“è§£æä¸­é—´ä»¶ï¼Œæ”¯æŒ multipartã€urlencoded å’Œ jsonçš„è¯·æ±‚ä½“ã€‚ä¸ express çš„ä¸»ä½“è§£æä¸­é—´ä»¶ multer ç±»ä¼¼

HTML ä»£ç å¦‚ä¸‹ï¼Œæ³¨æ„ï¼Œä¸Šä¼ æ–‡ä»¶å¿…é¡»è®¾ç½® `enctype="multipart/form-data"`ï¼š

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
<form method="post" action="http://localhost:8100" enctype="multipart/form-data">
    <input type="file" name="file1"/>
    <button type="submit">ä¸Š ä¼ </button>
</form>
</body>
</html>
```

nodejs ä»£ç ï¼Œé…ç½® koa-body å°±å¯ä»¥å®ç°ä¸Šä¼ æ–‡ä»¶çš„æ¥å£ï¼š

```js
const http = require('http');
const path = require('path');
const fs = require('fs');
const koaStatic = require('koa-static');
const koaBody = require('koa-body');
const Koa = require('koa2');

const app = new Koa();
const port = process.env.PORT || '8100';
const host = `http://localhost:${port}`;

app.use(koaBody({
    // å¼€å¯æ–‡ä»¶ä¸Šä¼ ï¼Œé»˜è®¤æ˜¯å…³é—­
    multipart: true,
    formidable: {
        // è®¾ç½®æ–‡ä»¶çš„ä¿å­˜ç›®å½•ï¼Œä¸è®¾ç½®åˆ™ä¿å­˜åœ¨ç³»ç»Ÿä¸´æ—¶ç›®å½•ä¸‹
        uploadDir: path.resolve(__dirname, './static'),
        // ä¿æŒæºæ–‡ä»¶çš„æ‰©å±•
        keepExtensions: true,
    },
}));

//å¼€å¯é™æ€æ–‡ä»¶è®¿é—®
app.use(koaStatic(
    path.resolve(__dirname, './static')
));

const server = http.createServer(app.callback());
server.listen(port);
console.log('server start');
```

å­˜åœ¨çš„é—®é¢˜ï¼š

- ä¸Šä¼ åçš„æ–‡ä»¶æ˜¯éšæœºå‘½åçš„
- ä¸Šä¼ å®Œæˆåä¸ä¼šç»™å‰ç«¯è¿”å›ç»“æœ

è¦è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼ŒåŠ ä¸Šä¸‹é¢çš„ä»£ç å³å¯ï¼š

```
//æ–‡ä»¶äºŒæ¬¡å¤„ç†ï¼Œä¿®æ”¹åç§°
app.use((ctx) => {
    const file = ctx.request.files.file1;
    const fpath = file.path;
    const fname = file.name;

    fs.renameSync(fpath, `${path.resolve(__dirname, './static')}/${fname}`);
    //ä»¥ json å½¢å¼è¾“å‡ºä¸Šä¼ æ–‡ä»¶åœ°å€
    ctx.body = `{
        "fileUrl":"${host}/static/${fname}"
    }`;
});
```

### Koa å¤šæ–‡ä»¶ä¸Šä¼ 

åŸç”Ÿçš„ nodejs å¦‚ä½•å®ç°å¤šæ–‡ä»¶ä¸Šä¼ ï¼Œæˆ‘ç›®å‰è¿˜æ²¡æœ‰æˆåŠŸï¼Œå› ä¸ºå¤šä¸ªæ–‡ä»¶åœ¨ä¸€ä¸ªboundaryçš„åˆ†å‰²ä¹‹å†…ï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•è§£æï¼Œä¹‹åæ‰¾åˆ°è§£å†³æ–¹æ³•ï¼Œä¼šåœ¨è¿™é‡Œæ›´æ–°ã€‚

HTML5 ä¸­ï¼Œé€šè¿‡è®¾ç½® input æ ‡ç­¾ multiple å±æ€§ï¼Œå¯ä»¥è¾¾åˆ°åŒæ—¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶çš„ç›®çš„ã€‚

```html
<input type="file" name="file1" multiple/> 
```

åœ¨ä¹‹å‰çš„ koa ä»£ç ä¸­ï¼Œå¦‚æœåªä½¿ç”¨ koa-body çš„åŸºæœ¬é…ç½®ï¼Œå°±å¯ä»¥å®ç°å¤šæ–‡ä»¶ä¸Šä¼ ï¼Œä½†æ˜¯å¦‚æœè¦è§£å†³æ¯ä¸ªæ–‡ä»¶ä¿æŒåŸæ–‡ä»¶çš„åå­—çš„è¯ï¼Œåœ¨æ–‡ä»¶äºŒæ¬¡å¤„ç†çš„åœ°æ–¹ä¿®æ”¹æˆä»¥ä¸‹ä»£ç ï¼š

```js
//æ–‡ä»¶äºŒæ¬¡å¤„ç†ï¼Œä¿®æ”¹åç§°
app.use((ctx) => {
    console.log(ctx.request.files);
    const files = ctx.request.files.file1;

    const urls = files.map(file => {
        const fpath = file.path;
        const fname = file.name;

        fs.renameSync(fpath, `${path.resolve(__dirname, './static')}/${fname}`);
        return `${host}/static/${fname}`;
    });

    //ä»¥ json å½¢å¼è¾“å‡ºä¸Šä¼ æ–‡ä»¶åœ°å€
    ctx.body = `{
        "fileUrl":"${urls}"
    }`;
});
```

åœ¨ä¸Šä¼ å¤šæ–‡ä»¶çš„æ—¶å€™ï¼Œfile1 æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€šè¿‡éå†ä¾æ¬¡ä¿®æ”¹æ–‡ä»¶åç§°ï¼Œæœ€åè¿”å›æ‰€æœ‰çš„æ–‡ä»¶çš„urlã€‚

### æ— åˆ·æ–°ä¸Šä¼ 

#### xhr ç»“åˆ FormData ä¸Šä¼ 

å‰é¢ç›´æ¥ä½¿ç”¨çš„æ˜¯ form è¡¨å•ä¸Šä¼ ï¼Œä¸Šä¼ æˆåŠŸä¹‹åï¼Œé¡µé¢ä¼šè¿›è¡Œåˆ·æ–°ï¼Œæ˜¯å¾ˆä¸å¥½çš„äº¤äº’ã€‚

æ‰€ä»¥è¿™é‡Œä½¿ç”¨ xhr ç»“åˆ FormData å®ç°ä¸Šä¼ ï¼Œåœ¨ js ä¸­æ‹¿åˆ° input çš„ files å€¼ï¼Œå»æ¨¡æ‹Ÿ FormDataï¼Œç„¶åä½¿ç”¨ xhr å‘é€è¯·æ±‚å®ç°ä¸Šä¼ ã€‚

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
<input type="file" id="file1" multiple />
<button type="submit" id="submit">ä¸Š ä¼ </button>
<script>
    document.getElementById('submit').addEventListener('click', function () {
        // è·å–æ–‡ä»¶åˆ—è¡¨ï¼Œæ³¨æ„è¿™é‡Œä¸æ˜¯æ•°ç»„ï¼Œè€Œæ˜¯å¯¹è±¡
        const fileList = document.getElementById('file1').files;
        if (!fileList.length) {
            alert('è¯·é€‰æ‹©æ–‡ä»¶');
            return;
        }
        let formData = new FormData();
        // å¤šæ–‡ä»¶éå†ç”Ÿæˆ formData å¯¹è±¡
        for (let i = 0, len = fileList.length; i < len; i++) {
            formData.append('file1', fileList[i]);
        }

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:8100', true);
        // å‘é€æ—¶ï¼ŒContent-Type é»˜è®¤æ˜¯ multipart/form-data
        xhr.send(formData);
        xhr.onreadystatechange = function () {
            console.log('state change', xhr.readyState);
            if (this.readyState === 4 && this.status === 200) {
                // è¿”å›å€¼
                const obj = JSON.parse(xhr.responseText);

                console.log(obj);

                if (obj.fileUrl.length) {
                    alert('ä¸Šä¼ æˆåŠŸ');
                }
            }
        }
    });
</script>
</body>
</html>
```

### è§£å†³è·¨åŸŸ

åœ¨å‰é¢åŸºç¡€æ¥å£éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨ form è¡¨å•è¿›è¡Œä¸Šä¼ ï¼Œä¸ä¼šå­˜åœ¨è·¨åŸŸé—®é¢˜ï¼Œä½†åœ¨ xhr ç»“åˆ FormData ä¸Šä¼ çš„æ—¶å€™ï¼Œç›´æ¥è°ƒç”¨åç«¯å°±ä¼šå­˜åœ¨è·¨åŸŸé—®é¢˜ã€‚

åŸå› æ˜¯ form è¡¨å•æäº¤åˆ°å¦ä¸€ä¸ªåŸŸåä¹‹åï¼ŒåŸæ¥é¡µé¢çš„è„šæœ¬æ˜¯è·å–ä¸åˆ°æ–°é¡µé¢ä¸­çš„å†…å®¹çš„ï¼Œæ‰€ä»¥æµè§ˆå™¨è®¤ä¸ºè¿™æ˜¯å®‰å…¨çš„ã€‚

ä½† xhr ç»“åˆ FormData ä¸Šä¼ çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥è¯»å–å“åº”å†…å®¹çš„ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¸ºäº†ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œè®¾ç½®äº†è·¨åŸŸã€‚

å‚è€ƒï¼š[ä¸ºä»€ä¹ˆformè¡¨å•æäº¤æ²¡æœ‰è·¨åŸŸé—®é¢˜ï¼Œä½†ajaxæäº¤æœ‰è·¨åŸŸé—®é¢˜ï¼Ÿ- çŸ¥ä¹](https://www.zhihu.com/question/31592553)

#### ä»€ä¹ˆæ˜¯è·¨åŸŸï¼Ÿ

è·¨åŸŸå®é™…ä¸Šæ˜¯**æµè§ˆå™¨åŒæºç­–ç•¥é™åˆ¶**çš„ä¸€ç±»è¯·æ±‚åœºæ™¯ã€‚

**åŒæºç­–ç•¥ï¼ˆSOPï¼šsame origin policyï¼‰**ï¼šæ˜¯ä¸€ç§çº¦å®šï¼Œæ˜¯æµè§ˆå™¨æœ€æ ¸å¿ƒçš„å®‰å…¨åŠŸèƒ½ï¼Œå¦‚æœç¼ºå°‘äº†åŒæºç­–ç•¥ï¼Œæµè§ˆå™¨å¾ˆå®¹æ˜“å—åˆ° **XSS**ã€**CSFR**ç­‰æ”»å‡»ã€‚**åŒæº**æ˜¯æŒ‡åè®®ã€åŸŸåã€ç«¯å£ä¸‰è€…ç›¸åŒã€‚

#### koa è§£å†³è·¨åŸŸ

å®‰è£… koa-corsï¼š

```bash
npm i -S koa-cors
```

æ·»åŠ ä»£ç ï¼š

```js
const cors = require('koa-cors');

app.use(cors());
```

#### nodejs åŸç”Ÿè§£å†³è·¨åŸŸ

å‰ç«¯å‘é€è¯·æ±‚æ—¶é…ç½®ï¼š

```js
// å‰ç«¯è®¾ç½®æ˜¯å¦å…è®¸å¸¦ cookie
xhr.withCredentials = true;
```

åç«¯è¿™æ˜¯ response å‚æ•°ï¼š

```js
res.writeHead(200, {
		// åç«¯å…è®¸å‘é€Cookie
    'Access-Control-Allow-Credentials': 'true',
    // å…è®¸è®¿é—®çš„åŸŸï¼ˆåè®®+åŸŸå+ç«¯å£ï¼‰
    'Access-Control-Allow-Origin': 'xxx',    
});
```

è¿™é‡Œä½¿ç”¨çš„è§£å†³è·¨åŸŸçš„æ–¹æ³•éƒ½å±äº **CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰**ï¼Œæ›´å¤šçš„è§£å†³åŠæ³•å‚è€ƒï¼š[å‰ç«¯å¸¸è§è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼ˆå…¨ï¼‰](https://juejin.im/entry/59b8fb276fb9a00a42474a6f)ã€‚

### ä¸Šä¼ å›¾ç‰‡é¢„è§ˆ

HTML ä¸­æ·»åŠ ä¸€ä¸ªå­˜æ”¾é¢„è§ˆå›¾ç‰‡çš„ divï¼š

```
<div class="preview-container" id="preview"></div>
```

JS ä¸­æ·»åŠ é¢„è§ˆé€»è¾‘ï¼š

```js
document.getElementById('file1').addEventListener('change', function (e) {
  	const files = e.target.files;
  	const previewContainer = document.getElementById('preview');

  	for (let i = 0, len = files.length; i < len; i++) {
    	let file = files[i];
    	let img = document.createElement('img');
    	img.src = window.URL.createObjectURL(file);
    	img.className = 'preview-item';

    	previewContainer.appendChild(img);
  }
});
```

> **URL.createObjectURL()** é™æ€æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª [`DOMString`](https://developer.mozilla.org/zh-CN/docs/Web/API/DOMString)ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªè¡¨ç¤ºå‚æ•°ä¸­ç»™å‡ºçš„å¯¹è±¡çš„URLã€‚è¿™ä¸ª URL çš„ç”Ÿå‘½å‘¨æœŸå’Œåˆ›å»ºå®ƒçš„çª—å£ä¸­çš„ [`document`](https://developer.mozilla.org/zh-CN/docs/Web/API/Document) ç»‘å®šã€‚è¿™ä¸ªæ–°çš„URL å¯¹è±¡è¡¨ç¤ºæŒ‡å®šçš„ [`File`](https://developer.mozilla.org/zh-CN/docs/Web/API/File) å¯¹è±¡æˆ– [`Blob`](https://developer.mozilla.org/zh-CN/docs/Web/API/Blob) å¯¹è±¡ã€‚

### ä¸Šä¼ è¿›åº¦

- å€ŸåŠ© **XMLHttpRequest** çš„ **onprogress** api å¯ä»¥å®ç°é¢„è§ˆå›¾ç‰‡ä¸Šä¼ è¿›åº¦çš„åŠŸèƒ½

- å€ŸåŠ©ä¸Šä¼ äº‹ä»¶çš„ event å¯¹è±¡çš„ **event.loaded** å’Œ **event.total** è®¡ç®—æ–‡ä»¶ä¸Šä¼ çš„ç™¾åˆ†æ¯”
- å¤šæ–‡ä»¶ä¸Šä¼ å¦‚æœéœ€è¦è®¡ç®—ä¸Šä¼ è¿›åº¦éœ€è¦ä¾æ¬¡åˆ†åˆ«åˆ›å»º xhr å¯¹è±¡å¹¶å‘é€è¯·æ±‚

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <style>
        .preview-container .preview-item img {
            width: 200px;
        }
        .red {
            background: red;
        }
        .green {
            background: green;
        }
        .progress {
            height: 20px;
        }
    </style>
</head>
<body>
<input type="file" id="file1" multiple />
<button type="submit" id="submit">ä¸Š ä¼ </button>
<div class="preview-container" id="preview"></div>
<script>
    let willUploadFiles = [];
    document.getElementById('file1').addEventListener('change', function (e) {
        const files = e.target.files;
        const previewContainer = document.getElementById('preview');

				// éå†ä¾æ¬¡åˆ›å»ºé¢„è§ˆå’Œè¿›åº¦çš„ DOM
        for (let i = 0, len = files.length; i < len; i++) {
            let file = files[i];
            let wrapper = document.createElement('div');
            wrapper.className = 'preview-item';
            let img = document.createElement('img');
            img.src = window.URL.createObjectURL(file);
            let  progress = document.createElement('div');
            progress.className = 'progress';
            progress.innerHTML = '<span class="red"></span><button type="button">Abort</button>';

            wrapper.appendChild(img);
            wrapper.appendChild(progress);
            previewContainer.appendChild(wrapper);

						// æŠŠä¸Šä¼ çš„æ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯æš‚å­˜ï¼Œåç»­ä¸Šä¼ è¿›åº¦ä¿®æ”¹æ—¶ä½¿ç”¨
            willUploadFiles.push({file, wrapper, progress});
        }
    });
    document.getElementById('submit').addEventListener('click', function () {
        // è·å–æ–‡ä»¶åˆ—è¡¨ï¼Œæ³¨æ„è¿™é‡Œä¸æ˜¯æ•°ç»„ï¼Œè€Œæ˜¯å¯¹è±¡
        const fileList = document.getElementById('file1').files;
        if (!fileList.length) {
            alert('è¯·é€‰æ‹©æ–‡ä»¶');
            return;
        }
        willUploadFiles.forEach(item => {
            xhrSend(item.file, item.progress);
        });
    });

    function xhrSend(file, progress) {
        let progressSpan = progress.firstElementChild;
        progressSpan.style.width = '0';
        progressSpan.classList.remove('green');

        let formData = new FormData();
        formData.append('file1', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:8100', true);

        xhr.onreadystatechange = function () {
            console.log('state change', xhr.readyState);
            if (this.readyState === 4 && this.status === 200) {
                // è¿”å›å€¼
                const obj = JSON.parse(xhr.responseText);
                console.log(obj);
            }
        };

        xhr.onprogress = updateProgress;
        xhr.upload.onprogress = updateProgress;

        function updateProgress (event) {
            // ProgressEvent.lengthComputable æ ‡ç¤º ProgressEvent æ‰€å…³è”çš„èµ„æºæ˜¯å¦å…·æœ‰å¯ä»¥è®¡ç®—çš„é•¿åº¦
            if (event.lengthComputable) {
                // è®¡ç®—ä¸Šä¼ ç™¾åˆ†æ¯”
                let completedPercent = (event.loaded / event.total * 100).toFixed(2);
                progressSpan.style.width = `${completedPercent}%`;
                progressSpan.innerHTML = `${completedPercent}%`;

                // è¿›åº¦æ¡å˜è‰²
                if (completedPercent > 90) {
                    progressSpan.classList.add('green');
                } else if(completedPercent >= 100){
                    xhr.uploaded = true;
                }
                console.log('å·²ä¸Šä¼ ',completedPercent);
            }
        }

        // å‘é€æ—¶ï¼ŒContent-Type é»˜è®¤æ˜¯ multipart/form-data
        xhr.send(formData);

        let abortBtn = progress.getElementsByTagName('button')[0];
        abortBtn.addEventListener('click', function (e) {
            if (xhr && xhr.readyState !== 4) {
                // å–æ¶ˆä¸Šä¼ 
                xhr.abort();
            }
        });
    }
</script>
</body>
</html>
```

### æ‹–æ‹½ä¸Šä¼ 

åŸºäº HTML5 **æ‹–æ‹½**æ–°ç‰¹æ€§ï¼Œå¯ä»¥å®ç°æ‹–æ‹½è¿›å…¥åŒºåŸŸï¼Œä¸Šä¼ æ–‡ä»¶çš„åŠŸèƒ½ã€‚

- ç¦ç”¨æµè§ˆå™¨çš„é»˜è®¤æ‹–æ”¾è¡Œä¸º
- ç›‘å¬ **drop** äº‹ä»¶
- **drop** äº‹ä»¶ä¸­ï¼Œé€šè¿‡ **e.dataTransfer.files** è·å–æ‹–æ‹½ä¸­çš„æ–‡ä»¶å¯¹è±¡
- ä½¿ç”¨ **FormData** å’Œ **xhr** ç»“åˆä¸Šä¼ æ–‡ä»¶

å…·ä½“çš„ä»£ç å°±ä¸è´´äº†ã€‚

> å•Šï¼Œå†™å®Œäº†ï¼Œæˆ‘è¦åšæŒï¼ğŸ¤¯